<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Platos - Cafeter√≠a NamNam</title>
    <style>
        :root{ --bg:#f5f7fb; --card:#fff; --muted:#7f8c8d; --small:13px; }
        body{ margin:0; font-family:'Segoe UI', Tahoma, Verdana, sans-serif; background:var(--bg); }
        .container{ padding:1.25rem; }
        .card{ background:var(--card); padding:1rem; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
        .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .muted { color:var(--muted); font-size:var(--small); }
        .thumb { max-width:80px; max-height:60px; border-radius:6px; object-fit:cover; }
    </style>
</h:head>
<h:body>
    <h:form id="mainForm">
        <f:event type="preRenderView" listener="#{platoBean.cargarPlatos}" />

        <div class="container">
            <div class="card">
                <div class="header">
                    <div>
                        <h2>Platos</h2>
                        <small class="muted">Total: <strong>#{platoBean.platos.size()}</strong></small>
                    </div>
                    <div>
                        <p:messages id="msgs" autoUpdate="true" showDetail="true" showSummary="false" closable="true" />
                        <p:commandButton icon="pi pi-refresh" title="Refrescar"
                                         actionListener="#{platoBean.cargarPlatos}" process="@this"
                                         update="@form" ajax="true" />
                        <p:commandButton value="‚ûï Nuevo desde Receta" icon="pi pi-plus"
                                         actionListener="#{platoBean.prepararNuevoPlato}"
                                         process="@this"
                                         update="@form"
                                         oncomplete="PF('dlgNuevoPlato').show()" ajax="true" />
                        <p:commandButton value="üß© Generar todos desde recetas" icon="pi pi-play"
                                         title="Crea un plato por cada receta que no tenga uno"
                                         actionListener="#{platoBean.generarPlatosDesdeRecetas}"
                                         process="@this"
                                         update="@form"
                                         styleClass="ui-button-secondary" ajax="true" />
                    </div>
                </div>

                <p:dataTable id="dtPlatos" value="#{platoBean.platos}" var="p"
                             paginator="true" rows="10" responsiveLayout="scroll" emptyMessage="No hay platos"
                             style="width:100%">

                    <p:column headerText="ID" style="width:80px; text-align:center;">
                        <h:outputText value="#{p.platoId}" />
                    </p:column>

                    <p:column headerText="Imagen" style="width:110px; text-align:center;">
                        <h:panelGroup>
                            <h:outputLink value="#{p.imagen}" target="_blank">
                                <h:graphicImage value="#{p.imagen}" styleClass="thumb"
                                                rendered="#{not empty p.imagen and (p.imagen.endsWith('jpg') or p.imagen.endsWith('png'))}" />
                                <h:outputText value="Ver"
                                              rendered="#{empty p.imagen or (not p.imagen.endsWith('jpg') and not p.imagen.endsWith('png'))}" />
                            </h:outputLink>
                        </h:panelGroup>
                    </p:column>

                    <p:column headerText="Nombre" style="text-align:left;">
                        <h:outputText value="#{p.nombre}" />
                    </p:column>

                    <p:column headerText="Costo" style="width:140px; text-align:right;">
                        <h:outputText value="#{p.costo != null ? p.costo : 0}" />
                    </p:column>

                    <p:column headerText="Precio venta" style="width:160px; text-align:right;">
                        <h:outputText value="#{p.precioVenta != null ? p.precioVenta : 0}" />
                    </p:column>

                    <p:column headerText="Acciones" style="width:260px; text-align:center;">
                        <p:commandButton icon="pi pi-search" title="Ver detalle"
                                         actionListener="#{platoBean.verDetalles(p)}"
                                         process="@this"
                                         update="@form"
                                         oncomplete="PF('dlgDetalle').show()" styleClass="ui-button-info" ajax="true"/>

                        <p:commandButton icon="pi pi-trash" title="Eliminar"
                                         actionListener="#{platoBean.eliminarPlato(p.platoId)}"
                                         process="@this"
                                         update="@form"
                                         styleClass="ui-button-danger" ajax="true" />
                    </p:column>

                </p:dataTable>
            </div>
        </div>

        <!-- DIALOG CREAR: crear siempre desde receta (no se pide costo manual) -->
        <p:dialog header="Crear Plato desde Receta"
                  widgetVar="dlgNuevoPlato"
                  modal="true"
                  closable="true"
                  width="720"
                  appendTo="@form">

            <h:panelGrid id="dlgNuevoGrid" columns="2" cellpadding="6">
                <h:outputLabel for="receta" value="Receta:" />
                <p:selectOneMenu id="receta" value="#{platoBean.selectedRecetaId}">
                    <f:selectItem itemLabel="-- Selecciona una receta --" itemValue="#{null}" />
                    <f:selectItems value="#{platoBean.recetasDisponibles}" var="r"
                                   itemValue="#{r.recetaId}"
                                   itemLabel="#{r.nombre} (id: #{r.recetaId})" />
                    <p:ajax event="change" listener="#{platoBean.onRecetaChange}" process="@this" update="@form" />
                </p:selectOneMenu>

                <h:outputLabel for="previewNombre" value="Nombre propuesto:" />
                <p:inputText id="previewNombre" value="#{platoBean.nuevoPlato.nombre}" />

                <h:outputLabel for="costo" value="Costo (calculado):" />
                <p:inputText id="costo" value="#{platoBean.nuevoPlato.costo}" readonly="true" />

                <h:outputLabel for="precio" value="Precio venta (calculado):" />
                <p:inputText id="precio" value="#{platoBean.nuevoPlato.precioVenta}" readonly="true" />

                <h:outputLabel for="imagen" value="Imagen (opcional):" />
                <p:inputText id="imagen" value="#{platoBean.nuevoPlato.imagen}" />
            </h:panelGrid>

            <p:separator />
            <div style="text-align:right;">
                <p:commandButton value="Crear desde receta" icon="pi pi-save"
                                 actionListener="#{platoBean.crearPlatoDesdeReceta}"
                                 process="@form"
                                 update="@form"
                                 oncomplete="PF('dlgNuevoPlato').hide()" styleClass="ui-button-success" ajax="true" />
            </div>
        </p:dialog>

        <!-- DIALOG DETALLE -->
        <p:dialog header="Detalle del Plato" widgetVar="dlgDetalle" modal="true" id="dlgDetalle" closable="true" appendTo="@form">
            <h:panelGrid id="dlgDetalleGrid" columns="2" cellpadding="6">
                <h:outputText value="ID:" />
                <h:outputText value="#{platoBean.platoSeleccionado.platoId}" />

                <h:outputText value="Nombre:" />
                <h:outputText value="#{platoBean.platoSeleccionado.nombre}" />

                <h:outputText value="Costo:" />
                <h:outputText value="#{platoBean.platoSeleccionado.costo}" />

                <h:outputText value="Precio venta:" />
                <h:outputText value="#{platoBean.platoSeleccionado.precioVenta}" />

                <h:outputText value="Imagen:" />
                <h:panelGroup>
                    <h:graphicImage value="#{platoBean.platoSeleccionado.imagen}" styleClass="thumb" rendered="#{not empty platoBean.platoSeleccionado.imagen}" />
                    <h:outputText value="(sin imagen)" rendered="#{empty platoBean.platoSeleccionado.imagen}" />
                </h:panelGroup>

                <h:outputText value="Receta asociada (id):" />
                <h:outputText value="#{platoBean.platoSeleccionado.recetaId}" />
            </h:panelGrid>
        </p:dialog>

    </h:form>
</h:body>
</html>
