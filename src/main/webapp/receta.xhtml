<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Recetas - Cafetería NamNam</title>
    <style>
        :root{ --bg:#f5f7fb; --card:#fff; --muted:#7f8c8d; --small:13px; }
        body{ margin:0; font-family:'Segoe UI', Tahoma, Verdana, sans-serif; background:var(--bg); }
        .container{ padding:1.25rem; }
        .card{ background:var(--card); padding:1rem; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
        .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .muted { color:var(--muted); font-size:var(--small); }
        .col-truncate { max-width:260px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block; }
        .thumb { max-width:80px; max-height:60px; border-radius:6px; object-fit:cover; }
        @media (max-width:900px){ .layout{ grid-template-columns: 1fr; } .sidebar{ display:none; } }
    </style>
</h:head>
<h:body>
    <h:form id="mainForm">
        <f:event type="preRenderView" listener="#{recetaBean.cargarRecetas}" />

        <div class="container">
            <div class="card">
                <div class="header">
                    <div>
                        <h2>Recetas</h2>
                        <small class="muted">Total: <strong>#{recetaBean.recetas.size()}</strong></small>
                    </div>
                    <div>
                        <p:messages id="msgs" autoUpdate="true" showDetail="true" showSummary="false" closable="true" />
                        <p:commandButton icon="pi pi-refresh" title="Refrescar"
                                         actionListener="#{recetaBean.cargarRecetas}" process="@this"
                                         update=":mainForm:dtRecetas :mainForm:msgs" />
                        <p:commandButton value="➕ Nueva Receta" icon="pi pi-plus"
                                         actionListener="#{recetaBean.prepararNuevaReceta}"
                                         oncomplete="PF('dlgNuevaReceta').show()" process="@this" />
                    </div>
                </div>

                <p:dataTable id="dtRecetas" value="#{recetaBean.recetas}" var="r"
                             paginator="true" rows="10" responsiveLayout="scroll" emptyMessage="No hay recetas"
                             style="width:100%">

                    <p:column headerText="ID" style="width:70px; text-align:center;">
                        <h:outputText value="#{r.recetaId}" />
                    </p:column>

                    <p:column headerText="Imagen" style="width:100px; text-align:center;">
                        <h:panelGroup>
                            <h:outputLink value="#{r.imagen}" target="_blank">
                                <h:graphicImage value="#{r.imagen}" styleClass="thumb" rendered="#{not empty r.imagen and r.imagen.endsWith('jpg')}" />
                                <h:outputText value="Ver" rendered="#{empty r.imagen or not r.imagen.endsWith('jpg')}" />
                            </h:outputLink>
                        </h:panelGroup>
                    </p:column>

                    <p:column headerText="Nombre" style="text-align:left;">
                        <h:outputText value="#{r.nombre}" styleClass="col-truncate" />
                    </p:column>

                    <p:column headerText="Tiempo (min)" style="width:120px; text-align:center;">
                        <h:outputText value="#{r.tiempoPreparacion != null ? r.tiempoPreparacion : 0}" />
                    </p:column>

                    <p:column headerText="Descripción">
                        <h:outputText value="#{r.descripcion}" styleClass="col-truncate" />
                    </p:column>

                    <p:column headerText="Ingredientes" style="width:160px; text-align:center;">
                        <p:commandButton value="Mostrar ingredientes"
                                         icon="pi pi-list"
                                         actionListener="#{recetaBean.verDetalles(r)}"
                                         update=":mainForm:dlgIngredientesGrid"
                                         oncomplete="PF('dlgIngredientes').show()"
                                         process="@this" />
                    </p:column>

                    <p:column headerText="Acciones" style="width:140px; text-align:center;">
                        <p:commandButton icon="pi pi-trash" title="Eliminar"
                                         actionListener="#{recetaBean.eliminarReceta(r.recetaId)}"
                                         update=":mainForm:dtRecetas :mainForm:msgs"
                                         process="@this" styleClass="ui-button-danger" />
                    </p:column>

                </p:dataTable>
            </div>
        </div>

        <!-- DIALOG CREAR -->
        <p:dialog header="Crear Receta" widgetVar="dlgNuevaReceta" modal="true" closable="true" width="820">
            <h:panelGrid id="dlgNuevaGrid" columns="2" cellpadding="6">
                <h:outputLabel for="nombre" value="Nombre:" />
                <p:inputText id="nombre" value="#{recetaBean.nuevaReceta.nombre}" required="true" />

                <h:outputLabel for="tiempo" value="Tiempo (min):" />
                <p:inputText id="tiempo" value="#{recetaBean.nuevaReceta.tiempoPreparacion}">
                    <f:convertNumber integerOnly="true" />
                </p:inputText>

                <h:outputLabel for="imagen" value="Imagen (URL .jpg):" />
                <p:inputText id="imagen" value="#{recetaBean.nuevaReceta.imagen}" />

                <h:outputLabel for="desc" value="Descripción:" />
                <p:inputTextarea id="desc" value="#{recetaBean.nuevaReceta.descripcion}" rows="3" cols="40" />
            </h:panelGrid>

            <p:separator />

            <!-- Agregar ingredientes: selector + cantidad -->
            <h:panelGrid columns="4" style="margin-top:1rem" cellpadding="6">
                <h:outputLabel value="Ingrediente:" for="selIng" />
                <p:selectOneMenu id="selIng" value="#{recetaBean.selectedIngredienteCodigo}">
                    <f:selectItem itemLabel="-- Seleccione --" itemValue="#{null}" />
                    <f:selectItems value="#{recetaBean.ingredientesDisponibles}" var="ing"
                                   itemValue="#{ing.codigo}"
                                   itemLabel="#{ing.nombre} (cod: #{ing.codigo})" />
                </p:selectOneMenu>

                <h:outputLabel value="Cantidad:" for="selCant" />
                <p:inputText id="selCant" value="#{recetaBean.selectedIngredienteCantidad}">
                    <f:convertNumber integerOnly="true" />
                </p:inputText>

                <p:commandButton value="Agregar" icon="pi pi-plus"
                                 actionListener="#{recetaBean.agregarIngredienteANuevaReceta}"
                                 process="@form"
                                 update=":mainForm:ingredientesTable :mainForm:msgs"
                                 oncomplete="PF('dlgNuevaReceta').show()" />
            </h:panelGrid>

            <!-- Tabla de ingredientes añadidos -->
            <h:panelGrid columns="1" style="margin-top:1rem">
                <p:dataTable id="ingredientesTable" value="#{recetaBean.nuevaReceta.ingredientes}" var="ing" rows="6" emptyMessage="Aún no hay ingredientes añadidos">
                    <p:column headerText="Código" style="width:80px">
                        <h:outputText value="#{ing.codigo}" />
                    </p:column>
                    <p:column headerText="Nombre">
                        <h:outputText value="#{ing.nombre}" />
                    </p:column>
                    <p:column headerText="Cantidad">
                        <h:outputText value="#{ing.cantidad}" />
                    </p:column>
                    <p:column headerText="Acciones" style="width:120px">
                        <p:commandButton icon="pi pi-trash" title="Remover"
                                         actionListener="#{recetaBean.removerIngredienteDeNuevaReceta(ing.codigo)}"
                                         update=":mainForm:ingredientesTable :mainForm:msgs" process="@this" />
                    </p:column>
                </p:dataTable>
            </h:panelGrid>

            <p:separator />
            <div style="text-align:right;">
                <p:commandButton value="Crear" icon="pi pi-save"
                                 actionListener="#{recetaBean.crearReceta}"
                                 process="@form"
                                 update=":mainForm:dtRecetas :mainForm:msgs"
                                 oncomplete="PF('dlgNuevaReceta').hide()" styleClass="ui-button-success" />
            </div>
        </p:dialog>

        <!-- DIALOG: Ingredientes de la receta -->
        <p:dialog header="Ingredientes de la Receta" widgetVar="dlgIngredientes" modal="true" id="dlgIngredientes" closable="true" width="600">
            <h:panelGrid id="dlgIngredientesGrid" columns="1" cellpadding="6">
                <p:dataTable value="#{recetaBean.recetaSeleccionada.ingredientes}" var="ing" rows="8" emptyMessage="No hay ingredientes en esta receta">
                    <p:column headerText="Código" style="width:90px">
                        <h:outputText value="#{ing.codigo}" />
                    </p:column>
                    <p:column headerText="Nombre">
                        <h:outputText value="#{ing.nombre}" />
                    </p:column>
                    <p:column headerText="Cantidad">
                        <h:outputText value="#{ing.cantidad}" />
                    </p:column>
                </p:dataTable>
            </h:panelGrid>
        </p:dialog>

    </h:form>
</h:body>
</html>
